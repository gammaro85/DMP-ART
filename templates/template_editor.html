<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Configuration - DMP ART</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/dmp-art-favicon (Niestandardowe).png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Template editor layout */
        .template-editor-container {
            padding: 20px !important;
            padding-bottom: 100px !important;
            min-height: calc(100vh - 120px) !important;
        }
        .tab-content {
            padding-bottom: 30px !important;
        }
        .comment-row {
            margin-bottom: 15px !important;
        }
        .category-questions {
            padding-bottom: 20px !important;
        }
        .template-editor-container input[type="text"],
        .template-editor-container textarea,
        .comment-name-input,
        .comment-text-input,
        .category-comment-textarea {
            font-size: 0.875rem !important;
        }
        /* Remove tab button - keep existing colors */
        .remove-tab-btn {
            background: var(--error-color) !important;
            color: white !important;
            border: 1px solid var(--error-color) !important;
            border-radius: 50% !important;
            width: 20px !important;
            height: 20px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin-left: 8px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            padding: 0 !important;
            line-height: 1 !important;
        }
        .remove-tab-btn:hover {
            background: #a71d2a !important;
            border-color: #a71d2a !important;
        }
        /* DMP Structure & category spacing */
        .structure-section {
            margin-top: 12px;
        }
        .structure-subsection {
            margin-top: 6px;
            padding-left: 20px;
        }
        .cat-question-block {
            margin-top: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
        }
        /* Language switcher */
        .header-language-switcher {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .header-lang-btn {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            border-radius: var(--border-radius-md);
            padding: 4px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }
        .header-lang-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .header-lang-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>
    <script>
        (function() {
            const saved = localStorage.getItem('dmp-art-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            const meta = document.querySelector('meta[name="theme-color"]');
            if (meta) meta.content = theme === 'dark' ? '#121212' : '#ffffff';
        })();
    </script>
</head>
<body data-page="template-editor">
    <header class="fixed-header">
        <nav class="header-nav">
            <div class="header-left-controls">
                <button class="theme-toggle" aria-label="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="header-language-switcher" id="te-lang-switcher">
                    <button id="te-lang-pl-btn" class="header-lang-btn active" data-lang="pl" title="Komentarze po polsku">
                        <i class="fas fa-language"></i> PL
                    </button>
                    <button id="te-lang-en-btn" class="header-lang-btn" data-lang="en" title="English comments">
                        <i class="fas fa-language"></i> EN
                    </button>
                </div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-item" data-page="index">Home</a>
                <span class="nav-item disabled" data-page="review"
                      title="Upload and process a document first to access review">Review</span>
                <a href="/template_editor" class="nav-item" data-page="template-editor">Configuration</a>
                <a href="/ai-settings" class="nav-item" data-page="ai-settings">AI Settings</a>
                <a href="/documentation" class="nav-item" data-page="documentation">Documentation</a>
            </div>
        </nav>
    </header>

    <main class="template-editor-container">
        <div class="page-header">
            <h1>Configuration</h1>
            <p>Manage DMP structure, quick comments, and feedback categories for review</p>
        </div>

        <div class="tab-navigation" id="tab-navigation">
            <button class="tab-btn active" data-tab="dmp-structure"><i class="fas fa-list"></i> DMP Structure</button>
            <button class="tab-btn" data-tab="quick-comments"><i class="fas fa-comment"></i> Quick Comments</button>
            <!-- Category tabs will be injected here -->
            <button class="add-category-btn" id="add-category-btn"><i class="fas fa-plus"></i> new</button>
        </div>

        <div class="tab-content" id="tab-content">
            <!-- DMP Structure Tab -->
            <div class="tab-panel active" id="dmp-structure-panel">
                <div class="panel-header">
                    <h2>DMP Structure</h2>
                    <p>Define the structure of your DMP. This structure is used for review and for all categories.</p>
                </div>
                <div class="structure-content" id="dmp-structure-list">
                    <!-- Structure loaded from dmp_structure.json -->
                </div>
            </div>
            
            <!-- Quick Comments Tab -->
            <div class="tab-panel" id="quick-comments-panel">
                <div class="panel-header">
                    <h2>Quick Comments</h2>
                    <p>Edit quick comments available in the review sidebar.</p>
                </div>
                <div class="comments-list" id="quick-comments-list"></div>
                <div class="action-row">
                    <button class="btn btn-primary" id="add-quick-comment"><i class="fas fa-plus"></i> Add Quick Comment</button>
                    <button class="btn btn-success" id="save-quick-comments"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </div>
            
            <!-- Category tabs will be injected here -->
        </div>
    </main>

    <!-- Quick Comment Modal -->
    <div id="add-comment-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="comment-modal-title">Add Quick Comment</h3>
                <button type="button" class="close-btn" id="close-comment-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="comment-name">Comment Name:</label>
                    <input type="text" id="comment-name" placeholder="Enter comment name" maxlength="100">
                </div>
                <div class="form-group">
                    <label for="comment-text">Comment Text:</label>
                    <textarea id="comment-text" rows="4" placeholder="Enter comment text" maxlength="500"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-comment">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-comment">Save Comment</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
    <script>
    // --- Utility Functions ---
    function fetchJSON(url) {
        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            });
    }
    
    function postJSON(url, data) {
        return fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(r => r.json());
    }

    // --- Global Variables ---
    let currentTab = "dmp-structure";
    let categories = [];
    let dmpStructure = [];
    let quickComments = [];
    let editingCommentIndex = -1;
    let dataLoaded = {
        dmpStructure: false,
        quickComments: false,
        categories: false
    };

    // --- DOM Ready ---
    document.addEventListener('DOMContentLoaded', function() {
        loadAllConfig();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Tab switching
        document.getElementById('tab-navigation').addEventListener('click', function(e) {
            const btn = e.target.closest('.tab-btn');
            if (btn && !btn.classList.contains('active')) {
                switchTab(btn.getAttribute('data-tab'));
            }
        });

        // Add category button
        document.getElementById('add-category-btn').onclick = () => createNewCategoryTab();

        // Quick comment modal  
        document.getElementById('add-quick-comment').onclick = () => openCommentModal();
        document.getElementById('close-comment-modal').onclick =
        document.getElementById('cancel-comment').onclick = () => closeCommentModal();
        document.getElementById('save-comment').onclick = saveQuickComment;
        document.getElementById('save-quick-comments').onclick = saveQuickComments;

        // Close modals on outside click
        window.onclick = function(event) {
            const commentModal = document.getElementById('add-comment-modal');
            if (event.target === commentModal) closeCommentModal();
        };
    }

    // --- Tab Management ---
    function switchTab(tabId) {
        currentTab = tabId;
        
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        
        const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
        const panel = document.getElementById(`${tabId}-panel`);
        
        if (btn) btn.classList.add('active');
        if (panel) panel.classList.add('active');
        
        // Render content based on tab - always attempt render, functions will handle loading states
        if (tabId === 'dmp-structure') {
            renderDmpStructure();
        } else if (tabId === 'quick-comments') {
            renderQuickComments();
        } else {
            renderCategoryPanel(tabId);
        }
    }

    // --- Data Loading ---
    function loadAllConfig() {
        // Load DMP structure
        fetchJSON('/config/dmp_structure.json')
            .then(data => {
                dmpStructure = data.structure || [];
                dataLoaded.dmpStructure = true;
                if (currentTab === 'dmp-structure') {
                    renderDmpStructure();
                }
            })
            .catch(err => console.error('Error loading DMP structure:', err));

        // Load quick comments
        fetchJSON('/config/quick_comments.json')
            .then(data => {
                quickComments = data.quick_comments || [];
                dataLoaded.quickComments = true;
                if (currentTab === 'quick-comments') {
                    renderQuickComments();
                }
            })
            .catch(err => console.error('Error loading quick comments:', err));

        // Load categories 
        fetchJSON('/list_categories')
            .then(data => {
                categories = data.categories || [];
                dataLoaded.categories = true;
                renderCategoryTabs();
            })
            .catch(err => console.error('Error loading categories:', err));
    }

    // --- DMP Structure Rendering ---
    function renderDmpStructure() {
        const container = document.getElementById('dmp-structure-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!dataLoaded.dmpStructure) {
            container.innerHTML = '<div class="loading">Loading DMP structure...</div>';
            return;
        }
        
        if (!dmpStructure.length) {
            container.innerHTML = '<div class="empty-state">No DMP structure found. Check dmp_structure.json file.</div>';
            return;
        }
        
        dmpStructure.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'structure-section';
            sectionDiv.innerHTML = `
                <h3 class="structure-header">${section.id}. ${section.question}</h3>
            `;
            container.appendChild(sectionDiv);
            
            if (section.subsections && section.subsections.length > 0) {
                section.subsections.forEach(sub => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'structure-subsection';
                    subDiv.innerHTML = `
                        <div class="subsection-header">${sub.id} ${sub.question}</div>
                    `;
                    container.appendChild(subDiv);
                });
            }
        });
    }

    // --- Quick Comments Management ---

    // Helper function to get text value (handles both string and bilingual object)
    function getTextValue(text, lang = 'en') {
        if (typeof text === 'string') {
            return text;
        } else if (typeof text === 'object' && text !== null) {
            return text[lang] || text['en'] || '';
        }
        return '';
    }

    // Helper function to ensure bilingual text structure
    function ensureBilingualText(text) {
        if (typeof text === 'string') {
            // Convert string to bilingual object
            return { en: text, pl: text };
        } else if (typeof text === 'object' && text !== null && (text.en || text.pl)) {
            // Already bilingual, ensure both languages exist
            return {
                en: text.en || text.pl || '',
                pl: text.pl || text.en || ''
            };
        }
        // Default empty bilingual object
        return { en: '', pl: '' };
    }

    function renderQuickComments() {
        const list = document.getElementById('quick-comments-list');
        if (!list) return;

        list.innerHTML = '';

        if (!dataLoaded.quickComments) {
            list.innerHTML = '<div class="loading">Loading quick comments...</div>';
            return;
        }

        if (!quickComments.length) {
            list.innerHTML = '<div class="empty-state">No quick comments yet. Click "Add Quick Comment" to get started.</div>';
            return;
        }

        quickComments.forEach((comment, idx) => {
            // Ensure text is in bilingual format
            const bilingualText = ensureBilingualText(comment.text);
            const textEn = escapeHtml(bilingualText.en || '');
            const textPl = escapeHtml(bilingualText.pl || '');

            const row = document.createElement('div');
            row.className = 'comment-row';
            row.innerHTML = `
                <div class="comment-info">
                    <input type="text" class="comment-name-input" value="${escapeHtml(comment.name || '')}"
                           placeholder="Comment name" data-idx="${idx}" data-field="name">
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 3px;">English (EN)</label>
                            <textarea class="comment-text-input" rows="3"
                                      placeholder="English text" data-idx="${idx}" data-field="text_en">${textEn}</textarea>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 3px;">Polish (PL)</label>
                            <textarea class="comment-text-input" rows="3"
                                      placeholder="Polish text" data-idx="${idx}" data-field="text_pl">${textPl}</textarea>
                        </div>
                    </div>
                </div>
                <div class="comment-actions">
                    <button class="btn btn-sm btn-success" title="Save This Comment" onclick="saveIndividualComment(${idx})">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" title="Delete" onclick="removeQuickComment(${idx})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            list.appendChild(row);
        });

        // Add event listeners for inline editing
        document.querySelectorAll('.comment-name-input, .comment-text-input').forEach(input => {
            input.addEventListener('change', function() {
                const idx = parseInt(this.getAttribute('data-idx'));
                const field = this.getAttribute('data-field');
                updateQuickCommentField(idx, field, this.value);
            });
        });
    }

    function openCommentModal(index = -1) {
        // Note: This modal is no longer used for editing since we do inline editing
        // Keeping it for potential future use or adding new comments via button
        editingCommentIndex = index;
        const modal = document.getElementById('add-comment-modal');
        const title = document.getElementById('comment-modal-title');
        const nameInput = document.getElementById('comment-name');
        const textInput = document.getElementById('comment-text');

        if (index >= 0 && quickComments[index]) {
            title.textContent = 'Edit Quick Comment';
            nameInput.value = quickComments[index].name || '';
            // Show English version by default in modal
            const bilingualText = ensureBilingualText(quickComments[index].text);
            textInput.value = bilingualText.en || '';
        } else {
            title.textContent = 'Add Quick Comment';
            nameInput.value = '';
            textInput.value = '';
        }

        modal.style.display = 'flex';
        nameInput.focus();
    }

    function closeCommentModal() {
        document.getElementById('add-comment-modal').style.display = 'none';
        editingCommentIndex = -1;
    }

    function saveQuickComment() {
        const name = document.getElementById('comment-name').value.trim();
        const text = document.getElementById('comment-text').value.trim();

        if (!name || !text) {
            alert('Please fill in both fields');
            return;
        }

        // Create bilingual text object (use same text for both languages initially)
        const bilingualText = { en: text, pl: text };

        if (editingCommentIndex >= 0) {
            quickComments[editingCommentIndex] = { name, text: bilingualText };
        } else {
            quickComments.push({ name, text: bilingualText });
        }

        renderQuickComments();
        closeCommentModal();
    }

    function removeQuickComment(index) {
        if (confirm('Are you sure you want to delete this quick comment?')) {
            quickComments.splice(index, 1);
            renderQuickComments();
        }
    }

    // Update individual field (handles name, text_en, text_pl)
    function updateQuickCommentField(index, field, value) {
        if (!quickComments[index]) return;

        if (field === 'name') {
            quickComments[index].name = value;
        } else if (field === 'text_en') {
            // Ensure text is bilingual object
            const bilingualText = ensureBilingualText(quickComments[index].text);
            bilingualText.en = value;
            quickComments[index].text = bilingualText;
        } else if (field === 'text_pl') {
            // Ensure text is bilingual object
            const bilingualText = ensureBilingualText(quickComments[index].text);
            bilingualText.pl = value;
            quickComments[index].text = bilingualText;
        }
    }

    function saveIndividualComment(index) {
        const comment = quickComments[index];
        if (!comment) return;

        // Validate name
        if (!comment.name || !comment.name.trim()) {
            showMessage('Comment name is required', 'error');
            return;
        }

        // Validate text (check both languages)
        const bilingualText = ensureBilingualText(comment.text);
        const hasEnglish = bilingualText.en && bilingualText.en.trim();
        const hasPolish = bilingualText.pl && bilingualText.pl.trim();

        if (!hasEnglish && !hasPolish) {
            showMessage('At least one language text is required', 'error');
            return;
        }

        // Ensure comment has proper bilingual structure before saving
        quickComments[index].text = bilingualText;

        // Save the entire quick comments array (since the backend expects the full array)
        postJSON('/save_quick_comments', { quick_comments: quickComments })
            .then(data => {
                if (data.success) {
                    showMessage(`Comment "${comment.name}" saved successfully!`, 'success');
                } else {
                    showMessage('Error saving comment: ' + data.message, 'error');
                }
            })
            .catch(err => {
                console.error('Error saving comment:', err);
                showMessage('Error saving comment', 'error');
            });
    }

    function saveQuickComments() {
        // Validate all comments before saving
        for (let i = 0; i < quickComments.length; i++) {
            const comment = quickComments[i];

            if (!comment.name || !comment.name.trim()) {
                showMessage(`Comment #${i + 1} is missing a name`, 'error');
                return;
            }

            // Ensure bilingual structure
            const bilingualText = ensureBilingualText(comment.text);
            const hasEnglish = bilingualText.en && bilingualText.en.trim();
            const hasPolish = bilingualText.pl && bilingualText.pl.trim();

            if (!hasEnglish && !hasPolish) {
                showMessage(`Comment "${comment.name}" needs at least one language text`, 'error');
                return;
            }

            // Update to bilingual structure
            quickComments[i].text = bilingualText;
        }

        postJSON('/save_quick_comments', { quick_comments: quickComments })
            .then(data => {
                if (data.success) {
                    showMessage('All quick comments saved successfully!', 'success');
                } else {
                    showMessage('Error saving quick comments: ' + data.message, 'error');
                }
            })
            .catch(err => {
                console.error('Error saving quick comments:', err);
                showMessage('Error saving quick comments', 'error');
            });
    }

    // --- Category Management ---
    function getCategoryLang(catName) {
        // Determine language affinity from category name suffix
        const lower = (catName || '').toLowerCase();
        if (lower.endsWith('_pl') || lower.endsWith(' pl')) return 'pl';
        if (lower.endsWith('_en') || lower.endsWith(' en')) return 'en';
        return 'shared'; // always visible
    }

    function filterCategoryTabsByLang(lang) {
        document.querySelectorAll('.tab-btn[data-category]').forEach(tab => {
            const catName = tab.getAttribute('data-category');
            const catLang = getCategoryLang(catName);
            if (catLang === 'shared' || catLang === lang) {
                tab.style.display = '';
            } else {
                tab.style.display = 'none';
                // If current tab is hidden, switch to first visible tab
                if (tab.classList.contains('active')) {
                    switchTab('dmp-structure');
                }
            }
        });
    }

    // Expose for language switcher
    window.reloadCategoriesWithLang = function(lang) {
        filterCategoryTabsByLang(lang);
    };

    function renderCategoryTabs() {
        // Remove existing category tabs and panels
        document.querySelectorAll('.tab-btn[data-category], .tab-panel[data-category]').forEach(e => e.remove());

        const nav = document.getElementById('tab-navigation');
        const addBtn = document.getElementById('add-category-btn');
        const content = document.getElementById('tab-content');

        if (!categories.length) {
            return;
        }

        const activeLang = localStorage.getItem('dmp-art-comment-language') || 'pl';

        categories.forEach(cat => {
            const catLang = getCategoryLang(cat.name);
            // Create tab button
            const tab = document.createElement('button');
            tab.className = 'tab-btn';
            tab.setAttribute('data-tab', cat.file);
            tab.setAttribute('data-category', cat.name);
            tab.style.display = (catLang === 'shared' || catLang === activeLang) ? '' : 'none';
            tab.innerHTML = `
                <i class="fas fa-folder"></i> ${escapeHtml(cat.name)}
                <button class="remove-tab-btn" title="Delete Category" onclick="event.stopPropagation(); removeCategoryTab('${cat.file}')">×</button>
            `;
            nav.insertBefore(tab, addBtn);

            // Create panel
            const panel = document.createElement('div');
            panel.className = 'tab-panel';
            panel.id = `${cat.file}-panel`;
            panel.setAttribute('data-category', cat.name);
            content.appendChild(panel);
        });
    }

    function renderCategoryPanel(tabId) {
        if (!dataLoaded.categories) {
            return;
        }
        
        const cat = categories.find(c => c.file === tabId);
        if (!cat) {
            return;
        }
        
        const panel = document.getElementById(`${cat.file}-panel`);
        if (!panel) return;
        
        panel.innerHTML = `
            <div class="panel-header">
                <h2>${escapeHtml(cat.name)} Category</h2>
                <p>Edit feedback comments for each DMP section in this category.</p>
                <div class="action-row">
                    <button class="btn btn-success" onclick="saveCategory('${cat.file}')">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
            <div class="category-questions" id="catq-${cat.file}">
                <div class="loading">Loading category data...</div>
            </div>
        `;
        
        // Load category data
        fetchJSON(`/api/load-category/${cat.file}`)
            .then(result => {
                if (result.success) {
                    renderCategoryQuestions(cat.file, result.data);
                } else {
                    document.getElementById(`catq-${cat.file}`).innerHTML =
                        `<div class="error-state">Error: ${result.message}</div>`;
                }
            })
            .catch(err => {
                console.error('Error loading category data:', err);
                document.getElementById(`catq-${cat.file}`).innerHTML =
                    '<div class="error-state">Error loading category data</div>';
            });
    }

    function renderCategoryQuestions(file, catData) {
        const container = document.getElementById(`catq-${file}`);
        if (!container) return;

        container.innerHTML = '';

        // Use category data directly - keys are section IDs like "1.1", "1.2", etc.
        let categoryData = {};
        for (const [key, value] of Object.entries(catData)) {
            if (!key.startsWith('_')) {
                categoryData[key] = value;
            }
        }

        console.log(`Loading category data for ${file}:`, categoryData);
        
        // Flatten DMP structure for rendering
        let flatStructure = [];
        dmpStructure.forEach(section => {
            flatStructure.push({ id: section.id, question: section.question });
            if (section.subsections) {
                section.subsections.forEach(sub => flatStructure.push({ id: sub.id, question: sub.question }));
            }
        });
        
        flatStructure.forEach(item => {
            const block = document.createElement('div');
            block.className = 'cat-question-block';
            block.setAttribute('data-section-id', item.id);
            
            const rawComments = categoryData[item.id] || [];
            const comments = Array.isArray(rawComments) ? rawComments : [];
            
            block.innerHTML = `
                <h4 class="question-header">${item.id} — ${escapeHtml(item.question)}</h4>
                <div class="question-comments" id="comments-wrap-${file}-${item.id}">
                    ${comments.map((comment, idx) => `
                        <div class="category-comment-item">
                            <textarea class="category-comment-textarea" rows="3" placeholder="Enter comment...">${escapeHtml(comment)}</textarea>
                            <button class="btn btn-sm btn-danger" title="Delete" onclick="deleteCategoryComment('${file}','${item.id}',${idx})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
                <div class="comment-item-actions">
                    <button class="btn btn-sm btn-success" onclick="addCategoryQuestionComment('${file}','${item.id}')">
                        <i class="fas fa-plus"></i> Add Comment
                    </button>
                </div>
            `;
            container.appendChild(block);
        });
    }

    function addCategoryQuestionComment(file, questionId) {
        const wrap = document.getElementById(`comments-wrap-${file}-${questionId}`);
        const commentDiv = document.createElement('div');
        commentDiv.className = 'category-comment-item';
        commentDiv.innerHTML = `
            <textarea class="category-comment-textarea" rows="3" placeholder="Enter comment..."></textarea>
            <button class="btn btn-sm btn-danger" title="Delete" onclick="this.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        `;
        wrap.appendChild(commentDiv);
    }

    function deleteCategoryComment(file, questionId, idx) {
        if (confirm('Are you sure you want to delete this comment?')) {
            const wrap = document.getElementById(`comments-wrap-${file}-${questionId}`);
            const items = wrap.querySelectorAll('.category-comment-item');
            if (items[idx]) items[idx].remove();
        }
    }

    function saveCategory(file) {
        const questionsDiv = document.getElementById(`catq-${file}`);
        const sectionData = {};
        
        questionsDiv.querySelectorAll('.cat-question-block').forEach(block => {
            const sectionId = block.getAttribute('data-section-id');
            const comments = [];
            
            block.querySelectorAll('.category-comment-textarea').forEach(textarea => {
                const comment = textarea.value.trim();
                if (comment) comments.push(comment);
            });
            
            // Always save the section, even if empty, to maintain structure
            sectionData[sectionId] = comments;
        });
        
        // Create the nested structure that matches our JSON files
        // Find the category name from the file mapping
        const categoryName = file; // Use file name as category name for now
        const data = {};
        data[categoryName] = sectionData;
        
        console.log(`Saving category ${file}:`, data);
        
        postJSON('/save_category', { file, data })
            .then(resp => {
                if (resp.success) {
                    showMessage('Category saved successfully!', 'success');
                } else {
                    showMessage('Error saving category: ' + resp.message, 'error');
                }
            })
            .catch(err => {
                console.error('Error saving category:', err);
                showMessage('Error saving category', 'error');
            });
    }

    function createNewCategoryTab() {
        const tempTabId = 'new-category-' + Date.now();
        const nav = document.getElementById('tab-navigation');
        const addBtn = document.getElementById('add-category-btn');
        const content = document.getElementById('tab-content');
        
        // Create temporary tab button
        const tab = document.createElement('button');
        tab.className = 'tab-btn';
        tab.setAttribute('data-tab', tempTabId);
        tab.innerHTML = `<i class="fas fa-plus"></i> New Category`;
        nav.insertBefore(tab, addBtn);

        // Create temporary panel with form
        const panel = document.createElement('div');
        panel.className = 'tab-panel';
        panel.id = `${tempTabId}-panel`;
        panel.innerHTML = `
            <div class="panel-header">
                <h2>Create New Category</h2>
                <p>Enter a name for your new category.</p>
            </div>
            <div class="category-form">
                <div class="form-group">
                    <label for="new-category-name">Category Name:</label>
                    <input type="text" id="new-category-name" placeholder="Enter category name" maxlength="50">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="submitNewCategory('${tempTabId}')">
                        <i class="fas fa-save"></i> Create Category
                    </button>
                    <button class="btn btn-secondary" onclick="cancelNewCategory('${tempTabId}')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;
        content.appendChild(panel);
        
        // Switch to new tab
        switchTab(tempTabId);
        
        // Focus on input
        setTimeout(() => {
            document.getElementById('new-category-name').focus();
        }, 100);
    }

    function submitNewCategory(tempTabId) {
        const name = document.getElementById('new-category-name').value.trim();
        if (!name) {
            alert('Please enter a category name');
            return;
        }
        
        postJSON('/create_category', { name })
            .then(data => {
                if (data.success) {
                    // Remove temporary tab and panel
                    removeTempTab(tempTabId);
                    
                    // Reload categories and switch to new one
                    loadAllConfig();
                    setTimeout(() => {
                        const newCategoryFile = data.file || name.toLowerCase().replace(/\s+/g, '_');
                        switchTab(newCategoryFile);
                    }, 100);
                    showMessage('Category created successfully!', 'success');
                } else {
                    showMessage('Error creating category: ' + data.message, 'error');
                }
            })
            .catch(err => {
                console.error('Error creating category:', err);
                showMessage('Error creating category', 'error');
            });
    }

    function cancelNewCategory(tempTabId) {
        removeTempTab(tempTabId);
        switchTab('dmp-structure');
    }

    function removeTempTab(tempTabId) {
        const tab = document.querySelector(`[data-tab="${tempTabId}"]`);
        const panel = document.getElementById(`${tempTabId}-panel`);
        if (tab) tab.remove();
        if (panel) panel.remove();
    }

    function removeCategoryTab(file) {
        if (!confirm('Are you sure you want to delete this category? This action cannot be undone.')) return;
        
        postJSON('/delete_category', { file })
            .then(data => {
                if (data.success) {
                    loadAllConfig();
                    if (currentTab === file) {
                        switchTab('dmp-structure');
                    }
                    showMessage('Category deleted successfully!', 'success');
                } else {
                    showMessage('Error deleting category: ' + data.message, 'error');
                }
            })
            .catch(err => {
                console.error('Error deleting category:', err);
                showMessage('Error deleting category', 'error');
            });
    }

    // --- Utility Functions ---
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showMessage(message, type = 'info') {
        // Create message element
        const messageEl = document.createElement('div');
        messageEl.className = `message message-${type}`;
        messageEl.textContent = message;
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 300px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
        `;
        
        document.body.appendChild(messageEl);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.parentNode.removeChild(messageEl);
            }
        }, 3000);
    }

    // Theme toggle is handled by dark-mode.js

    // Language switcher for comment language in template editor
    (function() {
        const LANG_KEY = 'dmp-art-comment-language';
        function initLangSwitcher() {
            const plBtn = document.getElementById('te-lang-pl-btn');
            const enBtn = document.getElementById('te-lang-en-btn');
            if (!plBtn || !enBtn) return;

            let currentLang = localStorage.getItem(LANG_KEY) || 'pl';

            function setLang(lang) {
                currentLang = lang;
                localStorage.setItem(LANG_KEY, lang);
                plBtn.classList.toggle('active', lang === 'pl');
                enBtn.classList.toggle('active', lang === 'en');
                // Reload categories with new language if template editor is initialized
                if (typeof window.reloadCategoriesWithLang === 'function') {
                    window.reloadCategoriesWithLang(lang);
                }
            }

            plBtn.addEventListener('click', () => setLang('pl'));
            enBtn.addEventListener('click', () => setLang('en'));

            // Set initial state
            setLang(currentLang);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLangSwitcher);
        } else {
            initLangSwitcher();
        }
    })();
    </script>

    <footer class="site-footer site-footer--relative">
        <span>DMP ART &copy; 2025</span>
    </footer>
</body>
</html>