<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Template Editor - DMP ART</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/dmp-art-favicon (Niestandardowe).png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Prevent flash of wrong theme -->
    <script>
        (function() {
            const saved = localStorage.getItem('dmp-art-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            const meta = document.querySelector('meta[name="theme-color"]');
            if (meta) meta.content = theme === 'dark' ? '#121212' : '#ffffff';
        })();
    </script>
</head>
<body data-page="template-editor">
    <!-- Fixed Header Navigation -->
    <header class="fixed-header">
        <nav class="header-nav">
            <a href="/" class="nav-item">Home</a>
            <a href="#" class="nav-item" onclick="alert('Please upload and process a document first to access review')">Review</a>
            <a href="/template_editor" class="nav-item active">Template Editor</a>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="template-editor-container">
        <div class="page-header">
            <h1>Template Editor</h1>
            <p>Manage comment templates and categories for DMP review</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="quick-comments">
                <i class="fas fa-comment"></i> Quick Comments
            </button>
            <button class="tab-btn" data-tab="dmp-structure">
                <i class="fas fa-list"></i> DMP Structure
            </button>
            <button class="add-category-btn">
                <i class="fas fa-plus"></i> Add Category
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content">
            <!-- Quick Comments Tab -->
            <div class="tab-panel active" id="quick-comments-panel">
                <div class="panel-header">
                    <h2>Quick Comments</h2>
                    <p>These comments appear in a floating window on the review page as quick phrases</p>
                </div>
                
                <div class="comments-list" id="quick-comments-list">
                    <!-- Quick comments will be dynamically loaded here -->
                </div>
                
                <div class="action-row">
                    <button class="btn btn-primary" id="add-quick-comment">
                        <i class="fas fa-plus"></i> Add Quick Comment
                    </button>
                    <button class="btn btn-success" id="save-quick-comments">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>

            <!-- DMP Structure Tab -->
            <div class="tab-panel" id="dmp-structure-panel">
                <div class="panel-header">
                    <h2>DMP Structure</h2>
                    <p>Manage the structure of DMP questions and sections</p>
                </div>
                
                <div class="structure-content">
                    <div class="structure-list" id="dmp-structure-list">
                        {% for section_id, content in templates.items() %}
                        <div class="structure-item" data-section-id="{{ section_id }}">
                            <div class="structure-header">
                                <span class="section-id">{{ section_id }}</span>
                                <span class="section-question">{{ content.question }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="action-row">
                    <button class="btn btn-secondary" id="edit-structure">
                        <i class="fas fa-edit"></i> Edit Structure
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Category Modal -->
    <div class="modal" id="add-category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Category</h3>
                <button class="close-btn" id="close-category-modal">×</button>
            </div>
            <div class="modal-body">
                <label for="category-name">Category Name:</label>
                <input type="text" id="category-name" placeholder="Enter category name" maxlength="50">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-category">Cancel</button>
                <button class="btn btn-primary" id="create-category">Create Category</button>
            </div>
        </div>
    </div>

    <!-- Add Comment Modal -->
    <div class="modal" id="add-comment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Comment</h3>
                <button class="close-btn" id="close-comment-modal">×</button>
            </div>
            <div class="modal-body">
                <label for="comment-name">Short Name:</label>
                <input type="text" id="comment-name" placeholder="Enter short name" maxlength="50">
                
                <label for="comment-text">Comment Text:</label>
                <textarea id="comment-text" placeholder="Enter the full comment text" rows="4"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-comment">Cancel</button>
                <button class="btn btn-primary" id="save-comment">Save Comment</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
    <script src="{{ url_for('static', filename='js/template_editor.js') }}"></script>
    <script>
        // Template editor initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeTemplateEditor();
        });

        function initializeTemplateEditor() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Add category button
            document.querySelector('.add-category-btn').addEventListener('click', function() {
                document.getElementById('add-category-modal').style.display = 'flex';
            });

            // Modal functionality
            setupModals();
            
            // Load initial quick comments
            loadQuickComments();
        }

        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabId}-panel`).classList.add('active');
        }

        function setupModals() {
            // Close modals
            document.querySelectorAll('.close-btn, .btn-secondary').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });

            // Add quick comment
            document.getElementById('add-quick-comment').addEventListener('click', function() {
                document.getElementById('add-comment-modal').style.display = 'flex';
            });

            // Save comment
            document.getElementById('save-comment').addEventListener('click', saveComment);
            
            // Create category
            document.getElementById('create-category').addEventListener('click', createCategory);
            
            // Save quick comments
            document.getElementById('save-quick-comments').addEventListener('click', saveQuickComments);
        }

        function loadQuickComments() {
            // For now, show empty state
            const list = document.getElementById('quick-comments-list');
            list.innerHTML = '<div class="empty-state">No quick comments yet. Click "Add Quick Comment" to get started.</div>';
        }

        function saveComment() {
            const name = document.getElementById('comment-name').value.trim();
            const text = document.getElementById('comment-text').value.trim();
            
            if (!name || !text) {
                alert('Please fill in both fields');
                return;
            }

            // Add comment to the list (for now just add to UI)
            addCommentToUI(name, text);
            
            // Clear modal
            document.getElementById('comment-name').value = '';
            document.getElementById('comment-text').value = '';
            document.getElementById('add-comment-modal').style.display = 'none';
        }

        function addCommentToUI(name, text) {
            const list = document.getElementById('quick-comments-list');
            
            // Remove empty state if it exists
            const emptyState = list.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const commentItem = document.createElement('div');
            commentItem.className = 'comment-row';
            commentItem.innerHTML = `
                <div class="comment-info">
                    <div class="comment-name">${name}</div>
                    <div class="comment-text">${text}</div>
                </div>
                <div class="comment-actions">
                    <button class="btn btn-sm btn-danger" onclick="removeComment(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            list.appendChild(commentItem);
        }

        function removeComment(button) {
            if (confirm('Are you sure you want to remove this comment?')) {
                button.closest('.comment-row').remove();
                
                // Show empty state if no comments left
                const list = document.getElementById('quick-comments-list');
                if (list.children.length === 0) {
                    list.innerHTML = '<div class="empty-state">No quick comments yet. Click "Add Quick Comment" to get started.</div>';
                }
            }
        }

        function createCategory() {
            const name = document.getElementById('category-name').value.trim();
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }

            // Add new tab
            addCategoryTab(name);
            
            // Clear modal
            document.getElementById('category-name').value = '';
            document.getElementById('add-category-modal').style.display = 'none';
        }

        function addCategoryTab(name) {
            const tabNav = document.querySelector('.tab-navigation');
            const addBtn = tabNav.querySelector('.add-category-btn');
            
            // Create new tab button
            const newTab = document.createElement('button');
            newTab.className = 'tab-btn';
            newTab.setAttribute('data-tab', name.toLowerCase().replace(/\s+/g, '-'));
            newTab.innerHTML = `
                <i class="fas fa-folder"></i> ${name}
                <button class="remove-tab-btn" onclick="removeTab(event, '${name}')">×</button>
            `;
            
            tabNav.insertBefore(newTab, addBtn);
            
            // Create corresponding panel
            createCategoryPanel(name);
            
            // Add click listener
            newTab.addEventListener('click', function(e) {
                if (!e.target.classList.contains('remove-tab-btn')) {
                    switchTab(name.toLowerCase().replace(/\s+/g, '-'));
                }
            });
        }

        function createCategoryPanel(name) {
            const tabContent = document.querySelector('.tab-content');
            const panelId = name.toLowerCase().replace(/\s+/g, '-');
            
            const panel = document.createElement('div');
            panel.className = 'tab-panel';
            panel.id = `${panelId}-panel`;
            panel.innerHTML = `
                <div class="panel-header">
                    <h2>${name} Category</h2>
                    <p>Comments for DMP questions in the ${name} category</p>
                </div>
                
                <div class="category-questions" id="${panelId}-questions">
                    <!-- DMP structure will be populated here -->
                </div>
            `;
            
            tabContent.appendChild(panel);
            
            // Populate with DMP structure
            populateCategoryWithDMPStructure(panelId, name);
        }

        function populateCategoryWithDMPStructure(panelId, categoryName) {
            const questionsContainer = document.getElementById(`${panelId}-questions`);
            if (!questionsContainer) return;

            // DMP structure - this should come from the backend but we'll use the existing structure
            const dmpStructure = [
                { id: '1.1', question: 'How will new data be collected or produced and/or how will existing data be re-used?' },
                { id: '1.2', question: 'What data (for example the types, formats, and volumes) will be collected or produced?' },
                { id: '2.1', question: 'What metadata and documentation will accompany data?' },
                { id: '2.2', question: 'What data quality control measures will be used?' },
                { id: '3.1', question: 'How will data and metadata be stored and backed up during the research process?' },
                { id: '3.2', question: 'How will data security and protection of sensitive data be taken care of during the research?' },
                { id: '4.1', question: 'If personal data are processed, how will compliance with legislation be ensured?' },
                { id: '4.2', question: 'How will other legal issues, such as intellectual property rights and ownership, be managed?' },
                { id: '5.1', question: 'How and when will data be shared? Are there possible restrictions?' },
                { id: '5.2', question: 'How will data for preservation be selected, and where will data be preserved long-term?' },
                { id: '5.3', question: 'What methods or software tools will be needed to access and use the data?' },
                { id: '5.4', question: 'How will the application of a unique and persistent identifier to each data set be ensured?' },
                { id: '6.1', question: 'Who will be responsible for data management?' },
                { id: '6.2', question: 'What resources will be dedicated to data management and ensuring the data will be FAIR?' }
            ];

            questionsContainer.innerHTML = '';

            dmpStructure.forEach(item => {
                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-block';
                questionBlock.innerHTML = `
                    <div class="question-header">
                        <h4>Section ${item.id}</h4>
                        <p class="question-text">${item.question}</p>
                    </div>
                    
                    <div class="question-comments">
                        <div class="comments-list" id="comments-${panelId}-${item.id}">
                            <!-- Comments for this question will be added here -->
                        </div>
                        
                        <div class="comment-actions">
                            <button class="btn btn-sm btn-success" onclick="addQuestionComment('${panelId}', '${item.id}')">
                                <i class="fas fa-plus"></i> Add Comment
                            </button>
                        </div>
                    </div>
                `;
                
                questionsContainer.appendChild(questionBlock);
            });
        }

        function addQuestionComment(categoryId, questionId) {
            const commentText = prompt('Enter comment for this question:');
            if (!commentText || !commentText.trim()) return;

            const commentsList = document.getElementById(`comments-${categoryId}-${questionId}`);
            if (!commentsList) return;

            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.innerHTML = `
                <div class="comment-content">${commentText.trim()}</div>
                <div class="comment-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="removeQuestionComment(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            commentsList.appendChild(commentItem);
        }

        function removeQuestionComment(button) {
            if (confirm('Are you sure you want to remove this comment?')) {
                button.closest('.comment-item').remove();
            }
        }

        function saveQuickComments() {
            const commentItems = document.querySelectorAll('#quick-comments-list .comment-row');
            const quickComments = [];
            
            commentItems.forEach(item => {
                const name = item.querySelector('.comment-name').textContent;
                const text = item.querySelector('.comment-text').textContent;
                quickComments.push({ name, text });
            });

            fetch('/save_quick_comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    quick_comments: quickComments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Quick comments saved successfully!');
                } else {
                    alert('Error saving quick comments: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving quick comments');
            });
        }

        function saveCategoryData(categoryName) {
            const panelId = categoryName.toLowerCase().replace(/\s+/g, '-');
            const categoryData = {};

            // Get all question blocks for this category
            const questionBlocks = document.querySelectorAll(`#${panelId}-questions .question-block`);
            
            questionBlocks.forEach(block => {
                const questionId = block.querySelector('h4').textContent.replace('Section ', '');
                const comments = [];
                
                const commentItems = block.querySelectorAll('.comment-item');
                commentItems.forEach(item => {
                    comments.push(item.querySelector('.comment-content').textContent);
                });
                
                if (comments.length > 0) {
                    categoryData[questionId] = comments;
                }
            });

            fetch('/save_category', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    category_name: categoryName,
                    category_data: categoryData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Category "${categoryName}" saved successfully`);
                } else {
                    console.error('Error saving category:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Auto-save category data when comments are added
        function addQuestionComment(categoryId, questionId) {
            const commentText = prompt('Enter comment for this question:');
            if (!commentText || !commentText.trim()) return;

            const commentsList = document.getElementById(`comments-${categoryId}-${questionId}`);
            if (!commentsList) return;

            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.innerHTML = `
                <div class="comment-content">${commentText.trim()}</div>
                <div class="comment-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="removeQuestionComment(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            commentsList.appendChild(commentItem);
            
            // Auto-save category data
            const categoryName = categoryId.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            saveCategoryData(categoryName);
        }

        function removeTab(event, name) {
            event.stopPropagation();
            
            if (confirm(`Are you sure you want to remove the "${name}" category?`)) {
                const panelId = name.toLowerCase().replace(/\s+/g, '-');
                
                // Remove tab button
                event.target.closest('.tab-btn').remove();
                
                // Remove panel
                document.getElementById(`${panelId}-panel`).remove();
                
                // Switch to first tab if current tab was removed
                const firstTab = document.querySelector('.tab-btn');
                if (firstTab) {
                    firstTab.click();
                }
            }
        }
    </script>
</body>
</html>